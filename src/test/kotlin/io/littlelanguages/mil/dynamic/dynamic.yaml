- name: Hello World
  input: |
    (println "Hello world")
  output:
    program:
      values: [ ]
      procedures:
        - procedure:
            name: _main
            arguments: [ ]
            offsets: 0
            es:
              - call-procedure:
                  procedure:
                    external-procedure: println
                  es:
                    - 'Hello world'
- scenario:
    name: Declaration
    tests:
      - name: Invalid Form - too many arguments
        input: |
          (const x 10 20)
        output:
          - InvalidConstFormError:
              location: 0:1:1-14:1:15
      - name: Top-level constant
        input: |
          (const x 10)
        output:
          program:
            values:
              - x
            procedures:
              - procedure:
                  name: _main
                  arguments: [ ]
                  offsets: 0
                  es:
                    - assign:
                        symbol:
                          toplevel-value: x
                        e: 10
      - name: Top-level procedure
        input: |
          (const (add a b) (+ a b))
        output:
          program:
            values: [ ]
            procedures:
              - procedure:
                  name: add
                  arguments:
                    - a
                    - b
                  offsets: 2
                  es:
                    - call-procedure:
                        procedure:
                          external-procedure: +
                        es:
                          - parameter:
                              name: a
                              offset: 0
                          - parameter:
                              name: b
                              offset: 1
              - procedure:
                  name: _main
                  arguments: [ ]
                  offsets: 0
                  es: [ ]
      - name: Procedure with duplicate parameter names
        input: |
          (const (add a a) (+ a a))
        output:
          - DuplicateParameterNameError:
              name: a
              location: "14:1:15"
      - name: Values within a procedure
        input: |
          (const (double-sum a b)
            (const sum (+ a b))
            (+ sum sum)
          )
        output:
          program:
            values: []
            procedures:
              - procedure:
                  name: double-sum
                  arguments:
                    - a
                    - b
                  offsets: 3
                  es:
                    - assign:
                        symbol:
                          procedure-value:
                            name: sum
                            offset: 2
                        e:
                          call-procedure:
                            procedure:
                              external-procedure: +
                            es:
                              - parameter:
                                  name: a
                                  offset: 0
                              - parameter:
                                  name: b
                                  offset: 1
                    - call-procedure:
                        procedure:
                          external-procedure: +
                        es:
                          - procedure-value:
                              name: sum
                              offset: 2
                          - procedure-value:
                              name: sum
                              offset: 2
              - procedure:
                  name: _main
                  arguments: [ ]
                  offsets: 0
                  es: [ ]
- scenario:
    name: Identifier Reference
    tests:
      - name: Unknown value identifier
        input: |
          (println x)
        output:
          - UnknownSymbolError:
              name: x
              location: "9:1:10"
      - name: Unknown procedure identifier
        input: |
          (println (add 1 2))
        output:
          - UnknownSymbolError:
              name: add
              location: 10:1:11-12:1:13
      - name: Top-level value
        input: |
          (const x 10)

          (println x)
        output:
          program:
            values:
              - x
            procedures:
              - procedure:
                  name: _main
                  arguments: [ ]
                  offsets: 0
                  es:
                    - assign:
                        symbol:
                          toplevel-value: x
                        e: 10
                    - call-procedure:
                        procedure:
                          external-procedure: println
                        es:
                          - toplevel-value: x
      - name: Multiple top-level values
        input: |
          (const v1 1)
          (const v2 "Hello world")

          (println v1 v2)
        output:
          program:
            values:
              - v1
              - v2
            procedures:
              - procedure:
                  name: _main
                  arguments: []
                  offsets: 0
                  es:
                    - assign:
                        symbol:
                          toplevel-value: v1
                        e: 1
                    - assign:
                        symbol:
                          toplevel-value: v2
                        e: Hello world
                    - call-procedure:
                        procedure:
                          external-procedure: println
                        es:
                          - toplevel-value: v1
                          - toplevel-value: v2
      - name: Top-level procedure
        input: |
          (const (add a b) (+ a b))

          (println (add 1 2))
        output:
          program:
            values: [ ]
            procedures:
              - procedure:
                  name: add
                  arguments:
                    - a
                    - b
                  offsets: 2
                  es:
                    - call-procedure:
                        procedure:
                          external-procedure: +
                        es:
                          - parameter:
                              name: a
                              offset: 0
                          - parameter:
                              name: b
                              offset: 1
              - procedure:
                  name: _main
                  arguments: [ ]
                  offsets: 0
                  es:
                    - call-procedure:
                        procedure:
                          external-procedure: println
                        es:
                          - call-procedure:
                              procedure:
                                toplevel-procedure:
                                  name: add
                                  parameter-count: 2
                              es:
                                - 1
                                - 2
      - name: Top-level procedure with incorrect number of arguments
        input: |
          (const (add a b) (+ a b))

          (println (add))
          (println (add 1))
          (println (add 1 2 3))
        output:
          - ArgumentMismatchError:
              name: add
              expected: 2
              actual: 0
              location: 36:3:10-40:3:14
          - ArgumentMismatchError:
              name: add
              expected: 2
              actual: 1
              location: 52:4:10-58:4:16
          - ArgumentMismatchError:
              name: add
              expected: 2
              actual: 3
              location: 70:5:10-80:5:20
      - name: local forward declaration
        input: |
          (const a 9)

          (const (f)
              (const v1 a)
              (const a 10)
              (const v2 a)
              (+ v1 v2)
          )
        output:
          program:
            values:
              - a
            procedures:
              - procedure:
                  name: f
                  arguments: []
                  offsets: 3
                  es:
                    - assign:
                        symbol:
                          procedure-value:
                            name: v1
                            offset: 0
                        e:
                          toplevel-value: a
                    - assign:
                        symbol:
                          procedure-value:
                            name: a
                            offset: 1
                        e:
                          10
                    - assign:
                        symbol:
                          procedure-value:
                            name: v2
                            offset: 2
                        e:
                          procedure-value:
                            name: a
                            offset: 1
                    - call-procedure:
                        procedure:
                          external-procedure: +
                        es:
                          - procedure-value:
                              name: v1
                              offset: 0
                          - procedure-value:
                              name: v2
                              offset: 2
              - procedure:
                  name: _main
                  arguments: []
                  offsets: 0
                  es:
                    - assign:
                        symbol:
                          toplevel-value: a
                        e: 9

